    <!DOCTYPE html>
    <html lang="vi">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Trình Duyệt Ảnh Konachan Nâng Cao</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                color: #e2e8f0;
                line-height: 1.6;
                padding: 20px;
                min-height: 100vh;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }

            header {
                text-align: center;
                margin-bottom: 30px;
                padding: 25px;
                background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
                border-radius: 15px;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
                position: relative;
                overflow: hidden;
            }

            header::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
                transform: rotate(30deg);
            }

            h1 {
                font-size: 2.8rem;
                margin-bottom: 10px;
                color: white;
                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
                position: relative;
            }

            .description {
                font-size: 1.2rem;
                margin-bottom: 20px;
                color: #e0f2fe;
                position: relative;
                max-width: 700px;
                margin-left: auto;
                margin-right: auto;
            }

            .controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
                padding: 25px;
                background: rgba(30, 41, 59, 0.8);
                border-radius: 15px;
                box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
            }

            .control-group {
                display: flex;
                flex-direction: column;
            }

            .control-group.full-width {
                grid-column: 1 / -1;
            }

            label {
                margin-bottom: 10px;
                font-weight: 600;
                color: #93c5fd;
                display: flex;
                align-items: center;
            }

            label i {
                margin-right: 10px;
            }

            select,
            input,
            button {
                padding: 14px;
                border: none;
                border-radius: 8px;
                background: rgba(15, 23, 42, 0.7);
                color: #e2e8f0;
                font-size: 1rem;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
            }

            select:focus,
            input:focus {
                outline: none;
                box-shadow: 0 0 0 3px #3b82f6;
            }

            button {
                background: linear-gradient(to right, #2563eb, #3b82f6);
                color: white;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            button:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            }

            button:active {
                transform: translateY(0);
            }

            button:disabled {
                background: #475569;
                cursor: not-allowed;
                transform: none;
            }

            .secondary-btn {
                background: linear-gradient(to right, #475569, #64748b);
            }

            /* Custom Multi-select Dropdown */
            .custom-select {
                position: relative;
                width: 100%;
            }

            .select-btn {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 14px;
                border-radius: 8px;
                background: rgba(15, 23, 42, 0.7);
                color: #e2e8f0;
                cursor: pointer;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            }

            .select-btn span {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                flex-grow: 1;
                text-align: left;
            }

            .select-content {
                position: absolute;
                width: 100%;
                margin-top: 10px;
                border-radius: 8px;
                background: rgba(15, 23, 42, 0.95);
                box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
                z-index: 100;
                display: none;
                backdrop-filter: blur(10px);
                max-height: 300px;
                overflow-y: auto;
            }

            .select-search {
                padding: 10px;
                border-bottom: 1px solid #334155;
            }

            .select-search input {
                width: 100%;
                padding: 10px;
                border-radius: 5px;
                background: rgba(30, 41, 59, 0.8);
                color: #e2e8f0;
                border: 1px solid #334155;
            }

            .select-options {
                padding: 5px 0;
                max-height: 250px;
                overflow-y: auto;
            }

            .select-option {
                padding: 10px 15px;
                cursor: pointer;
                display: flex;
                align-items: center;
                transition: background 0.2s;
            }

            .select-option:hover {
                background: rgba(56, 66, 87, 0.8);
            }

            .select-option input {
                margin-right: 10px;
                width: 16px;
                height: 16px;
            }

            .select-option label {
                margin-bottom: 0;
                cursor: pointer;
                font-weight: normal;
                flex-grow: 1;
            }

            .tag-count {
                color: #93c5fd;
                font-size: 0.85rem;
                margin-left: 8px;
            }

            .selected-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 10px;
            }

            .selected-tag {
                background: rgba(56, 66, 87, 0.8);
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
            }

            .selected-tag i {
                margin-left: 5px;
                cursor: pointer;
            }

            .select-content.show {
                display: block;
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
                margin: 25px 0;
                flex-wrap: wrap;
            }

            .page-info {
                font-size: 1.2rem;
                font-weight: 600;
                color: #93c5fd;
                padding: 0 20px;
                background: rgba(15, 23, 42, 0.7);
                border-radius: 8px;
                padding: 10px 20px;
            }

            .view-controls {
                display: flex;
                gap: 10px;
                margin-left: auto;
            }

            .view-btn {
                padding: 10px 15px;
                background: rgba(15, 23, 42, 0.7);
                border-radius: 8px;
            }

            .view-btn.active {
                background: #3b82f6;
            }

            .gallery {
                display: grid;
                gap: 25px;
                margin-bottom: 40px;
            }

            .grid-view {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }

            .list-view .post {
                display: flex;
                height: auto;
            }

            .list-view .post img {
                width: 250px;
                height: 200px;
                flex-shrink: 0;
            }

            .list-view .post-info {
                flex-grow: 1;
            }

            .post {
                background: rgba(30, 41, 59, 0.8);
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                transition: all 0.3s ease;
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            .post:hover {
                transform: translateY(-5px) scale(1.02);
                box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
            }

            .post img {
                width: 100%;
                height: 250px;
                object-fit: cover;
                display: block;
                transition: transform 0.5s ease;
            }

            .post:hover img {
                transform: scale(1.05);
            }

            .post-info {
                padding: 20px;
                display: flex;
                flex-direction: column;
                flex-grow: 1;
            }

            .post-tags {
                font-size: 0.95rem;
                color: #cbd5e1;
                margin-bottom: 15px;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
                flex-grow: 1;
            }

            .post-meta {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: auto;
            }

            .post-id {
                font-size: 0.9rem;
                color: #93c5fd;
                font-weight: 600;
            }

            .post-rating {
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 600;
            }

            .rating-safe {
                background: #065f46;
                color: #6ee7b7;
            }

            .rating-questionable {
                background: #92400e;
                color: #fcd34d;
            }

            .rating-explicit {
                background: #991b1b;
                color: #fca5a5;
            }

            .loading {
                text-align: center;
                font-size: 1.3rem;
                padding: 50px;
                color: #93c5fd;
                grid-column: 1 / -1;
            }

            .loading i {
                margin-right: 10px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            .error {
                text-align: center;
                color: #f87171;
                padding: 25px;
                background: rgba(30, 41, 59, 0.8);
                border-radius: 12px;
                margin: 20px 0;
                grid-column: 1 / -1;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 1000;
                overflow: auto;
                padding: 50px 20px;
            }

            .modal-content {
                max-width: 1000px;
                margin: 0 auto;
                background: #1e293b;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            }

            .modal-header {
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #1e40af;
            }

            .modal-title {
                font-size: 1.5rem;
                color: white;
            }

            .close-modal {
                background: none;
                border: none;
                color: white;
                font-size: 1.8rem;
                cursor: pointer;
                padding: 0;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-body {
                padding: 20px;
                max-height: 70vh;
                overflow-y: auto;
            }

            .modal-image {
                width: 100%;
                border-radius: 8px;
                margin-bottom: 20px;
            }

            .modal-tags {
                margin-bottom: 20px;
                line-height: 1.8;
            }

            .tag {
                display: inline-block;
                background: #334155;
                padding: 5px 10px;
                border-radius: 20px;
                margin: 0 5px 5px 0;
                font-size: 0.9rem;
            }

            .modal-actions {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            footer {
                text-align: center;
                margin-top: 40px;
                padding: 25px;
                color: #94a3b8;
                font-size: 1rem;
                background: rgba(15, 23, 42, 0.7);
                border-radius: 12px;
            }

            .footer-links {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: 15px;
            }

            .footer-links a {
                color: #93c5fd;
                text-decoration: none;
                transition: color 0.3s;
            }

            .footer-links a:hover {
                color: #3b82f6;
            }

            @media (max-width: 768px) {
                .controls {
                    grid-template-columns: 1fr;
                }

                .list-view .post {
                    flex-direction: column;
                }

                .list-view .post img {
                    width: 100%;
                }

                .pagination {
                    flex-direction: column;
                }

                .view-controls {
                    margin-left: 0;
                }
            }

            .favorite-btn {
                background: none;
                border: none;
                color: #cbd5e1;
                cursor: pointer;
                font-size: 1.2rem;
                transition: color 0.3s;
                padding: 5px;
            }

            .favorite-btn.active {
                color: #f87171;
            }

            .history-btn {
                background: none;
                border: none;
                color: #cbd5e1;
                cursor: pointer;
                font-size: 1.2rem;
                transition: color 0.3s;
                padding: 5px;
            }

            .history-btn.active {
                color: #3b82f6;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <header>
                <h1><i class="fas fa-images"></i> Trình Duyệt Ảnh Konachan Nâng Cao</h1>
            </header>

            <div class="controls">
                <div class="control-group">
                    <label for="rating"><i class="fas fa-star"></i> Đánh giá:</label>
                    <select id="rating">
                        <option value="explicit" selected>Explicit (Mặc định)</option>
                        <option value="questionable">Questionable</option>
                        <option value="safe">Safe</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="tags-select"><i class="fas fa-tags"></i> Thẻ (Tags):</label>
                    <div class="custom-select">
                        <div class="select-btn" id="tags-select">
                            <span>Chọn tags...</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="select-content" id="tags-dropdown">
                            <div class="select-search">
                                <input type="text" placeholder="Tìm kiếm tags..." id="tags-search">
                            </div>
                            <div class="select-options" id="tags-options">
                                <div class="loading-tags">Đang tải tags...</div>
                            </div>
                        </div>
                        <div class="selected-tags" id="selected-tags"></div>
                    </div>
                </div>

                <div class="control-group">
                    <label for="sort"><i class="fas fa-sort"></i> Sắp xếp:</label>
                    <select id="sort">
                        <option value="score" selected>Điểm cao nhất</option>
                        <option value="favcount">Yêu thích nhất</option>
                        <option value="date">Mới nhất</option>
                        <option value="random">Ngẫu nhiên</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="limit"><i class="fas fa-list"></i> Số lượng mỗi trang:</label>
                    <select id="limit">
                        <option value="20">20 ảnh</option>
                        <option value="40">40 ảnh</option>
                        <option value="60">60 ảnh</option>
                        <option value="100" selected>100 ảnh</option>
                    </select>
                </div>

                <div class="control-group full-width">
                    <label for="blacklist"><i class="fas fa-ban"></i> Blacklist (loại trừ tags):</label>
                    <input type="text" id="blacklist" placeholder="Ví dụ: loli -guro -violent">
                </div>

                <div class="control-group">
                    <button id="search"><i class="fas fa-search"></i> Tìm kiếm</button>
                </div>

                <div class="control-group">
                    <button id="random" class="secondary-btn"><i class="fas fa-dice"></i> Ngẫu nhiên</button>
                </div>

                <div class="control-group">
                    <button id="clear-filters" class="secondary-btn"><i class="fas fa-filter"></i> Xóa bộ lọc</button>
                </div>

                <div class="control-group">
                    <button id="show-favorites"><i class="fas fa-heart"></i> Yêu thích</button>
                </div>
            </div>

            <div class="pagination">
                <button id="prev-page"><i class="fas fa-chevron-left"></i> Trang trước</button>
                <span class="page-info">Trang: <span id="current-page">1</span></span>
                <button id="next-page">Trang sau <i class="fas fa-chevron-right"></i></button>

                <div class="view-controls">
                    <button id="grid-view" class="view-btn active"><i class="fas fa-th"></i></button>
                    <button id="list-view" class="view-btn"><i class="fas fa-list"></i></button>
                </div>

                <button id="jump-to-page" class="secondary-btn"><i class="fas fa-forward"></i> Đến trang</button>
                <input type="number" id="page-input" placeholder="Trang" min="1" style="width: 80px;">
            </div>

            <div id="gallery" class="gallery grid-view">
                <div class="loading"><i class="fas fa-spinner"></i> Đang tải dữ liệu...</div>
            </div>

            <div class="pagination">
                <button id="prev-page-bottom"><i class="fas fa-chevron-left"></i> Trang trước</button>
                <span class="page-info">Trang: <span id="current-page-bottom">1</span></span>
                <button id="next-page-bottom">Trang sau <i class="fas fa-chevron-right"></i></button>
            </div>

            <footer>
                <p>Ứng dụng sử dụng Konachan API | Không có CORS | Dữ liệu chỉ phục vụ mục đích học tập</p>
                <div class="footer-links">
                    <a href="https://konachan.com" target="_blank"><i class="fas fa-external-link-alt"></i> Konachan</a>
                    <a href="#" id="settings-toggle"><i class="fas fa-cog"></i> Cài đặt</a>
                    <a href="#" id="help-toggle"><i class="fas fa-question-circle"></i> Trợ giúp</a>
                </div>
            </footer>
        </div>

        <!-- Modal xem ảnh -->
        <div id="image-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Chi tiết ảnh</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <img id="modal-image" class="modal-image" src="" alt="">
                    <div id="modal-tags" class="modal-tags"></div>
                    <div class="modal-actions">
                        <button id="download-btn"><i class="fas fa-download"></i> Tải về</button>
                        <button id="favorite-modal-btn" class="favorite-btn"><i class="far fa-heart"></i> Yêu thích</button>
                        <button id="open-original"><i class="fas fa-external-link-alt"></i> Xem gốc</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Biến toàn cục
                let currentPage = 1;
                let currentRating = 'explicit';
                let currentTags = '';
                let currentSort = 'score';
                let currentLimit = 100;
                let currentBlacklist = '';
                let maxPageReached = false;
                let favorites = JSON.parse(localStorage.getItem('konachanFavorites')) || [];
                let viewMode = 'grid';
                let allTags = [];
                let selectedTags = [];

                // Elements
                const galleryEl = document.getElementById('gallery');
                const ratingEl = document.getElementById('rating');
                const sortEl = document.getElementById('sort');
                const limitEl = document.getElementById('limit');
                const blacklistEl = document.getElementById('blacklist');
                const searchBtn = document.getElementById('search');
                const randomBtn = document.getElementById('random');
                const clearFiltersBtn = document.getElementById('clear-filters');
                const showFavoritesBtn = document.getElementById('show-favorites');
                const prevPageBtn = document.getElementById('prev-page');
                const nextPageBtn = document.getElementById('next-page');
                const prevPageBottomBtn = document.getElementById('prev-page-bottom');
                const nextPageBottomBtn = document.getElementById('next-page-bottom');
                const currentPageEl = document.getElementById('current-page');
                const currentPageBottomEl = document.getElementById('current-page-bottom');
                const pageInputEl = document.getElementById('page-input');
                const jumpToPageBtn = document.getElementById('jump-to-page');
                const gridViewBtn = document.getElementById('grid-view');
                const listViewBtn = document.getElementById('list-view');
                const imageModal = document.getElementById('image-modal');
                const modalImage = document.getElementById('modal-image');
                const modalTags = document.getElementById('modal-tags');
                const closeModalBtn = document.querySelector('.close-modal');
                const downloadBtn = document.getElementById('download-btn');
                const favoriteModalBtn = document.getElementById('favorite-modal-btn');
                const openOriginalBtn = document.getElementById('open-original');

                // Elements cho tags dropdown
                const tagsSelectBtn = document.getElementById('tags-select');
                const tagsDropdown = document.getElementById('tags-dropdown');
                const tagsSearch = document.getElementById('tags-search');
                const tagsOptions = document.getElementById('tags-options');
                const selectedTagsContainer = document.getElementById('selected-tags');

                // Hàm load tags từ API
                async function loadTags() {
                    try {
                        const apiUrl = 'https://konachan.com/tag.json?limit=2000&order=count';
                        const proxyUrl = `https://cors-anywhere.herokuapp.com/${apiUrl}`;

                        const response = await fetch(proxyUrl, {
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`Lỗi HTTP: ${response.status}`);
                        }

                        const tagsData = await response.json();
                        allTags = tagsData;

                        // Hiển thị tags
                        displayTags(tagsData);

                    } catch (error) {
                        console.error('Lỗi khi tải tags:', error);
                        tagsOptions.innerHTML = '<div class="error">Không thể tải tags từ API</div>';
                    }
                }

                // Hàm hiển thị tags trong dropdown
                function displayTags(tags) {
                    tagsOptions.innerHTML = '';

                    if (tags.length === 0) {
                        tagsOptions.innerHTML = '<div class="select-option">Không tìm thấy tags nào</div>';
                        return;
                    }

                    tags.forEach(tag => {
                        const option = document.createElement('div');
                        option.className = 'select-option';
                        option.innerHTML = `
                            <input type="checkbox" id="tag-${tag.id}" value="${tag.name}">
                            <label for="tag-${tag.id}">${tag.name}</label>
                            <span class="tag-count">(${tag.count})</span>
                        `;

                        // Kiểm tra nếu tag đã được chọn
                        if (selectedTags.includes(tag.name)) {
                            option.querySelector('input').checked = true;
                        }

                        // Sự kiện khi chọn tag
                        option.querySelector('input').addEventListener('change', function () {
                            if (this.checked) {
                                addTag(this.value);
                            } else {
                                removeTag(this.value);
                            }
                        });

                        tagsOptions.appendChild(option);
                    });
                }

                // Hàm thêm tag
                function addTag(tagName) {
                    if (!selectedTags.includes(tagName)) {
                        selectedTags.push(tagName);
                        updateSelectedTags();
                    }
                }

                // Hàm xóa tag
                function removeTag(tagName) {
                    const index = selectedTags.indexOf(tagName);
                    if (index > -1) {
                        selectedTags.splice(index, 1);
                        updateSelectedTags();
                    }
                }

                // Hàm cập nhật hiển thị tags đã chọn
                function updateSelectedTags() {
                    selectedTagsContainer.innerHTML = '';

                    if (selectedTags.length === 0) {
                        tagsSelectBtn.querySelector('span').textContent = 'Chọn tags...';
                        return;
                    }

                    tagsSelectBtn.querySelector('span').textContent = `${selectedTags.length} tags đã chọn`;

                    selectedTags.forEach(tag => {
                        const tagEl = document.createElement('div');
                        tagEl.className = 'selected-tag';
                        tagEl.innerHTML = `
                            ${tag}
                            <i class="fas fa-times" data-tag="${tag}"></i>
                        `;

                        tagEl.querySelector('i').addEventListener('click', function (e) {
                            e.stopPropagation();
                            removeTag(this.dataset.tag);

                            // Bỏ chọn trong dropdown
                            const checkbox = document.getElementById(`tag-${allTags.find(t => t.name === this.dataset.tag)?.id}`);
                            if (checkbox) {
                                checkbox.checked = false;
                            }
                        });

                        selectedTagsContainer.appendChild(tagEl);
                    });
                }

                // Hàm cập nhật trạng thái phân trang
                function updatePagination() {
                    currentPageEl.textContent = currentPage;
                    currentPageBottomEl.textContent = currentPage;

                    prevPageBtn.disabled = currentPage === 1;
                    prevPageBottomBtn.disabled = currentPage === 1;

                    nextPageBtn.disabled = maxPageReached;
                    nextPageBottomBtn.disabled = maxPageReached;
                }

                // Hàm fetch dữ liệu từ Konachan
                async function fetchPosts() {
                    const rating = ratingEl.value;
                    const sort = sortEl.value;
                    const limit = limitEl.value;
                    const blacklist = blacklistEl.value.trim();

                    // Cập nhật state
                    currentRating = rating;
                    currentSort = sort;
                    currentLimit = limit;
                    currentBlacklist = blacklist;
                    currentTags = selectedTags.join(' ');

                    // Hiển thị trạng thái loading
                    galleryEl.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Đang tải dữ liệu...</div>';

                    try {
                        // Tạo URL với proxy để tránh CORS
                        let tagsParam = selectedTags.length > 0 ? `${selectedTags.join('+')}` : '';
                        tagsParam += blacklist ? `+-${blacklist.split(' ').join('+-')}` : '';

                        const apiUrl = `https://konachan.com/post.json?limit=${limit}&page=${currentPage}&tags=rating:${rating}+order:${sort}${tagsParam ? `+${tagsParam}` : ''}`;
                        const proxyUrl = `https://cors-anywhere.herokuapp.com/${apiUrl}`;

                        const response = await fetch(proxyUrl, {
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`Lỗi HTTP: ${response.status}`);
                        }

                        const posts = await response.json();

                        // Kiểm tra nếu không còn trang tiếp theo
                        if (posts.length === 0) {
                            maxPageReached = true;
                            galleryEl.innerHTML = '<div class="error">Không còn dữ liệu nào nữa.</div>';
                            updatePagination();
                            return;
                        }

                        // Hiển thị bài đăng
                        displayPosts(posts);
                        maxPageReached = posts.length < limit;

                    } catch (error) {
                        console.error('Lỗi khi tải dữ liệu:', error);
                        galleryEl.innerHTML = `<div class="error">Lỗi khi tải dữ liệu: ${error.message}</div>`;
                    }

                    updatePagination();
                }

                // Hàm hiển thị bài đăng
                function displayPosts(posts) {
                    galleryEl.innerHTML = '';

                    if (posts.length === 0) {
                        galleryEl.innerHTML = '<div class="error">Không tìm thấy bài đăng nào.</div>';
                        return;
                    }

                    posts.forEach(post => {
                        const postEl = document.createElement('div');
                        postEl.className = `post rating-${post.rating}`;

                        // Xác định URL ảnh để hiển thị (ưu tiên preview)
                        const imageUrl = post.preview_url || post.jpeg_url;

                        // Rút gọn tags để hiển thị
                        const displayTags = post.tags.length > 100
                            ? post.tags.substring(0, 100) + '...'
                            : post.tags;

                        // Kiểm tra xem post có trong favorites không
                        const isFavorite = favorites.includes(post.id);

                        postEl.innerHTML = `
                            <img src="${imageUrl}" alt="Konachan post ${post.id}" loading="lazy" data-id="${post.id}" data-url="${post.file_url}">
                            <div class="post-info">
                                <div class="post-tags" title="${post.tags}">${displayTags}</div>
                                <div class="post-meta">
                                    <span class="post-id">ID: ${post.id}</span>
                                    <span class="post-rating rating-${post.rating}">${post.rating}</span>
                                </div>
                            </div>
                        `;

                        galleryEl.appendChild(postEl);
                    });

                    // Thêm sự kiện click để mở modal
                    document.querySelectorAll('.post img').forEach(img => {
                        img.addEventListener('click', function () {
                            openModal(this.dataset.id, this.dataset.url, this.src);
                        });
                    });

                    // Cập nhật class view mode
                    galleryEl.className = `gallery ${viewMode}-view`;
                }

                // Hàm mở modal xem ảnh
                function openModal(postId, imageUrl, previewUrl) {
                    // Tìm post dựa trên ID
                    fetch(`https://cors-anywhere.herokuapp.com/https://konachan.com/post.json?tags=id:${postId}`)
                        .then(response => response.json())
                        .then(posts => {
                            if (posts.length > 0) {
                                const post = posts[0];
                                modalImage.src = post.file_url;
                                modalTags.innerHTML = post.tags.split(' ').map(tag => `<span class="tag">${tag}</span>`).join('');

                                // Cập nhật nút favorite
                                const isFavorite = favorites.includes(post.id);
                                favoriteModalBtn.innerHTML = isFavorite
                                    ? '<i class="fas fa-heart"></i> Bỏ yêu thích'
                                    : '<i class="far fa-heart"></i> Yêu thích';
                                favoriteModalBtn.dataset.id = post.id;

                                // Cập nhật nút download và open original
                                downloadBtn.onclick = () => downloadImage(post.jpeg_url);
                                openOriginalBtn.onclick = () => window.open(`https://konachan.com/post/show/${post.id}`, '_blank');

                                imageModal.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Lỗi khi tải chi tiết ảnh:', error);
                        });
                }

                function downloadImage(url) {
                    const proxy = "https://cors-anywhere.herokuapp.com/";
                    fetch(proxy + url)
                        .then(response => response.blob())
                        .then(blob => {
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = url.split('/').pop();
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        })
                        .catch(error => {
                            console.error('Lỗi khi tải ảnh:', error);
                            alert('Không thể tải ảnh về.');
                        });
                }


                // Hàm hiển thị favorites
                function showFavorites() {
                    if (favorites.length === 0) {
                        galleryEl.innerHTML = '<div class="error">Bạn chưa có ảnh yêu thích nào.</div>';
                        return;
                    }

                    galleryEl.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Đang tải ảnh yêu thích...</div>';

                    // Lấy thông tin các post yêu thích
                    const promises = favorites.map(id =>
                        fetch(`https://cors-anywhere.herokuapp.com/https://konachan.com/post.json?tags=id:${id}`)
                            .then(response => response.json())
                            .then(posts => posts[0])
                    );

                    Promise.all(promises)
                        .then(posts => {
                            displayPosts(posts.filter(post => post !== undefined));
                        })
                        .catch(error => {
                            console.error('Lỗi khi tải ảnh yêu thích:', error);
                            galleryEl.innerHTML = '<div class="error">Có lỗi xảy ra khi tải ảnh yêu thích.</div>';
                        });
                }

                // Sự kiện cho dropdown tags
                tagsSelectBtn.addEventListener('click', function () {
                    tagsDropdown.classList.toggle('show');
                });

                // Sự kiện tìm kiếm tags
                tagsSearch.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    if (searchTerm) {
                        const filteredTags = allTags.filter(tag =>
                            tag.name.toLowerCase().includes(searchTerm)
                        );
                        displayTags(filteredTags);
                    } else {
                        displayTags(allTags);
                    }
                });

                // Đóng dropdown khi click bên ngoài
                document.addEventListener('click', function (e) {
                    if (!tagsSelectBtn.contains(e.target) && !tagsDropdown.contains(e.target)) {
                        tagsDropdown.classList.remove('show');
                    }
                });

                // Sự kiện cho nút tìm kiếm
                searchBtn.addEventListener('click', () => {
                    currentPage = 1;
                    maxPageReached = false;
                    fetchPosts();
                });

                // Sự kiện cho nút random
                randomBtn.addEventListener('click', () => {
                    selectedTags = ['order:random'];
                    updateSelectedTags();
                    currentPage = 1;
                    maxPageReached = false;
                    fetchPosts();
                });

                // Sự kiện cho nút clear filters
                clearFiltersBtn.addEventListener('click', () => {
                    selectedTags = [];
                    updateSelectedTags();
                    blacklistEl.value = '';
                    currentPage = 1;
                    maxPageReached = false;

                    // Reset tất cả checkbox
                    document.querySelectorAll('#tags-options input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });

                    fetchPosts();
                });

                // Sự kiện cho nút show favorites
                showFavoritesBtn.addEventListener('click', showFavorites);

                // Sự kiện cho nút phân trang
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        fetchPosts();
                    }
                });

                nextPageBtn.addEventListener('click', () => {
                    if (!maxPageReached) {
                        currentPage++;
                        fetchPosts();
                    } else {
                        alert('Bạn đã đến trang cuối cùng!');
                    }
                });

                prevPageBottomBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        fetchPosts();
                    }
                });

                nextPageBottomBtn.addEventListener('click', () => {
                    if (!maxPageReached) {
                        currentPage++;
                        fetchPosts();
                    } else {
                        alert('Bạn đã đến trang cuối cùng!');
                    }
                });

                // Sự kiện cho nút jump to page
                jumpToPageBtn.addEventListener('click', () => {
                    const page = parseInt(pageInputEl.value);
                    if (page && page > 0) {
                        currentPage = page;
                        maxPageReached = false;
                        fetchPosts();
                    }
                });

                // Sự kiện cho nút view mode
                gridViewBtn.addEventListener('click', () => {
                    viewMode = 'grid';
                    gridViewBtn.classList.add('active');
                    listViewBtn.classList.remove('active');
                    galleryEl.className = 'gallery grid-view';
                });

                listViewBtn.addEventListener('click', () => {
                    viewMode = 'list';
                    listViewBtn.classList.add('active');
                    gridViewBtn.classList.remove('active');
                    galleryEl.className = 'gallery list-view';
                });

                // Sự kiện cho modal
                closeModalBtn.addEventListener('click', () => {
                    imageModal.style.display = 'none';
                });

                window.addEventListener('click', (event) => {
                    if (event.target === imageModal) {
                        imageModal.style.display = 'none';
                    }
                });

                // Sự kiện cho nút favorite trong modal
                favoriteModalBtn.addEventListener('click', function () {
                    const postId = parseInt(this.dataset.id);
                    const index = favorites.indexOf(postId);

                    if (index > -1) {
                        favorites.splice(index, 1);
                        this.innerHTML = '<i class="far fa-heart"></i> Yêu thích';
                    } else {
                        favorites.push(postId);
                        this.innerHTML = '<i class="fas fa-heart"></i> Bỏ yêu thích';
                    }

                    // Lưu vào localStorage
                    localStorage.setItem('konachanFavorites', JSON.stringify(favorites));
                });

                // Tải dữ liệu ban đầu
                loadTags().then(() => {
                    fetchPosts();
                });
            });
        </script>


    </body>

    </html>
